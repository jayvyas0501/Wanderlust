<% layout("/layouts/boilerplate.ejs") %>

  <style>
    /* Filters */
    #filters {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 2rem;
      max-width: 1200px;
    }

    .filter {
      display: flex;
      flex-direction: column;
      justify-content: center;
      /* vertically center content */
      align-items: center;
      /* horizontally center content */
      text-align: center;
      /* center text under icon */
      opacity: 0.75;
      transition: 0.2s;
    }

    .filter:hover {
      opacity: 1;
      transform: translateY(-3px);
      cursor: pointer;
    }

    .filter i {
      font-size: 2rem;
      display: block;
      margin-bottom: 0.3rem;
      /* space between icon and text */
      transition: 0.3s;
    }

    .filter:hover i {
      transform: scale(1.3);
      color: #ff385c;
    }

    .filter a {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      text-decoration: none !important;
      color: inherit;
    }


    /* Tax toggle */
    .tax-toggle {
      border: 1px solid #ddd;
      height: 3rem;
      border-radius: 1rem;
      padding: 0 1rem;
      display: flex;
      align-items: center;
      margin-top: -1.5rem;
      background: #f9f9f9;
    }

    /* Listings grid */
    #listingsContainer {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 2rem;
  max-width: 1200px;
  margin: 0 auto 4rem auto; /* center container */
}

.listing-card {
  border-radius: 0.8rem;
  overflow: hidden;
  border: 1px solid #eee;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  transition: 0.3s;
  display: flex;
  flex-direction: column;
  background: #fff;
  max-width: 400px; /* max width for single card */
  margin: 0 auto; /* center card if alone */
}


    .listing-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .listing-card img {
      height: 18rem;
      object-fit: cover;
      width: 100%;
      border-bottom: 1px solid #eee;
      transition: 0.3s;
    }

    .listing-card .card-body {
      padding: 1rem;
      flex-grow: 1;
    }

    .card-text b {
      display: block;
      margin-bottom: 0.5rem;
      color: #222;
      font-size: 1.05rem;
    }

    .card-text {
      color: #555;
      font-size: 0.95rem;
    }

    .tax-info {
      color: #999;
      font-size: 0.85rem;
      margin-left: 0.3rem;
      display: none;
    }

    @media (max-width:768px) {
      #filters {
        display: none;
      }

      #listingsContainer {
        grid-template-columns: 1fr;
        gap: 1.5rem;
        padding: 0 1rem;
      }
    }
  </style>

  <div id="ajaxAlertContainer" class="container"></div>

  <div id="filters" class="container">
    <% const categories = ["Trending","Rooms","Iconic Cities","Mountains","Castles","Pools","Camping","Farms","Arctic","Domes","Boats"]; %>
<% const icons = ["fa-fire","fa-bed","fa-mountain-city","fa-mountain","fa-chess-rook","fa-person-swimming","fa-campground","fa-wheat-awn","fa-igloo","fa-landmark-dome","fa-ship"]; %>

        <% for(let i=0;i<categories.length;i++){ %>
          <div class="filter">
            <a href="/listings/category/<%= encodeURIComponent(categories[i]) %>"
              style="text-decoration:none !important; color:inherit;">
              <i class="fa-solid <%= icons[i] %>"></i>
              <p style="text-decoration:none !important; color:inherit;">
                <%= categories[i] %>
              </p>
            </a>
          </div>
          <% } %>
            <div class="tax-toggle">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault">
                <label class="form-check-label" for="flexSwitchCheckDefault">Display after taxes</label>
              </div>
            </div>
  </div>

  <div id="listingsContainer" class="container">
    <% for(let listing of allListing){ %>
      <a href="/listings/<%= listing._id %>" style="text-decoration:none !important; color:inherit;">
        <div class="listing-card" data-base-price="<%= listing.price %>">
          <img src="<%= listing.image?.url || '/images/placeholder.jpg' %>" alt="<%= listing.title %>" />
          <div class="card-body">
            <p class="card-text" style="text-decoration:none !important; color:inherit;">
              <b style="text-decoration:none !important; color:inherit;">
                <%= listing.title %>
              </b><br />
              <span class="price" style="text-decoration:none !important; color:inherit;">&#8377;<%= listing.price %>
              </span>
              <i class="tax-info" style="text-decoration:none !important; color:inherit;">+18% GST</i>
            </p>
          </div>
        </div>
      </a>
      <% } %>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const taxSwitch = document.getElementById("flexSwitchCheckDefault");

      function updatePrices() {
        const showTax = taxSwitch.checked;
        document.querySelectorAll("#listingsContainer .listing-card").forEach(card => {
          const basePrice = parseFloat(card.dataset.basePrice) || 0;
          const priceEl = card.querySelector(".price");
          const taxEl = card.querySelector(".tax-info");
          if (showTax) {
            priceEl.textContent = `₹${Math.round(basePrice * 1.18)}`;
            taxEl.style.display = "inline";
          } else {
            priceEl.textContent = `₹${basePrice}`;
            taxEl.style.display = "none";
          }
        });
      }

      taxSwitch.addEventListener("change", updatePrices);
      updatePrices();

      document.querySelectorAll("#filters .filter a").forEach(link => {
        link.addEventListener("click", async e => {
          e.preventDefault();
          const url = link.href + (link.href.includes("?") ? "&" : "?") + "ajax=1";
          try {
            const res = await fetch(url, { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' });
            if (res.headers.get('content-type')?.includes('application/json')) {
              const data = await res.json();
              const listings = data.listings || [];
              if (!listings.length) { alert('No listings found'); return; }
              document.getElementById("listingsContainer").innerHTML = listings.map(l => `
            <a href="/listings/${l._id}" style="text-decoration:none !important; color:inherit;">
              <div class="listing-card" data-base-price="${l.price}">
                <img src="${l.image?.url || '/images/placeholder.jpg'}" alt="${l.title || 'Untitled'}"/>
                <div class="card-body">
                  <p class="card-text" style="text-decoration:none !important; color:inherit;">
                    <b style="text-decoration:none !important; color:inherit;">${l.title || 'Untitled'}</b><br/>
                    <span class="price" style="text-decoration:none !important; color:inherit;">₹${l.price || 0}</span>
                    <i class="tax-info" style="text-decoration:none !important; color:inherit;">+18% GST</i>
                  </p>
                </div>
              </div>
            </a>
          `).join('');
              updatePrices();
              history.pushState({}, '', link.href);
            } else {
              window.location.href = link.href;
            }
          } catch (err) { console.error(err); alert('Error fetching listings'); }
        });
      });
    });
  </script>